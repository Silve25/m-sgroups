<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MSGROUPS ‚Äî Dashboard</title>
  <meta name="description" content="Dashboard de suivi des sessions (Google Sheets)." />
  <meta name="robots" content="noindex,nofollow" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#0b1020;
      --panel:#111834;
      --soft:#0f1630;
      --muted:#98a2b3;
      --text:#eaeef9;
      --line:#1d2443;
      --brand:#4f7cff;
      --ok:#16a34a;
      --warn:#f59e0b;
      --err:#ef4444;
      --radius:14px;
      --radius-sm:10px;
      --shadow:0 10px 30px rgba(0,0,0,.25);
      --header-h:64px;
      --maxw:1250px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #1b2460 0%, #0b1020 50%, #070a16 100%);
      color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit}

    /* Header */
    .header{
      position:sticky; top:0; z-index:50; height:var(--header-h);
      backdrop-filter:saturate(140%) blur(6px);
      background:linear-gradient(to bottom, rgba(7,10,22,.75), rgba(7,10,22,.35));
      border-bottom:1px solid var(--line);
    }
    .header__inner{
      max-width:var(--maxw); margin:0 auto; height:100%; padding:0 14px;
      display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; text-decoration:none;
      font-weight:800; letter-spacing:.2px;
    }
    .brand img{width:30px;height:30px;border-radius:8px;box-shadow:0 6px 20px rgba(79,124,255,.35)}
    .brand__name{font-size:16px; background:linear-gradient(90deg,#fff,#9db6ff); -webkit-background-clip:text; background-clip:text; color:transparent}
    .header__actions{display:flex; gap:8px}
    .btn{
      appearance:none; border:none; border-radius:10px; padding:.6rem .9rem; font-weight:700; cursor:pointer;
      color:#fff; background:#1b2553; border:1px solid #27306a;
      transition:.18s transform, .18s box-shadow, .18s background;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(18,24,54,.4)}
    .btn--brand{background:var(--brand); border-color:#3e67d6}
    .btn--ghost{background:transparent; border-color:#2a356b}

    /* Layout */
    .wrap{max-width:var(--maxw); margin:0 auto; padding:18px 14px 48px}
    .grid{display:grid; gap:14px;}
    .grid--kpis{grid-template-columns:repeat(4,1fr)}
    .grid--two{grid-template-columns:1fr 1fr}
    .grid--wide{grid-template-columns:2fr 1fr}
    .grid--three{grid-template-columns:repeat(3,1fr)}
    .grid--four{grid-template-columns:repeat(4,1fr)}
    @media (max-width:1200px){
      .grid--kpis{grid-template-columns:repeat(2,1fr)}
      .grid--two,.grid--wide{grid-template-columns:1fr}
      .grid--three{grid-template-columns:repeat(2,1fr)}
      .grid--four{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:640px){
      .grid--kpis,.grid--three,.grid--four{grid-template-columns:1fr}
    }

    /* Panels */
    .panel{
      background:linear-gradient(180deg,#0f1630 0%, #0c1228 100%);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .panel__head{
      padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .panel__title{font-size:14px; font-weight:800; color:#dfe6ff; letter-spacing:.3px}
    .panel__body{padding:14px 16px}
    .panel__sub{font-size:12px; color:var(--muted)}

    /* KPI cards */
    .kpi{
      display:grid; grid-template-columns:auto 1fr; gap:12px; align-items:center;
      padding:14px 16px;
      background:linear-gradient(180deg,#11193a,#0f1630);
      border:1px solid #1f274d; border-radius:var(--radius);
      box-shadow:0 12px 30px rgba(28,34,74,.35);
      position:relative; overflow:hidden;
    }
    .kpi::after{
      content:""; position:absolute; right:-50px; top:-60px; width:160px; height:160px; border-radius:50%;
      background:radial-gradient(closest-side,rgba(79,124,255,.25), transparent 70%);
      filter:blur(6px); pointer-events:none;
    }
    .kpi__icon{width:42px;height:42px;border-radius:12px; display:grid;place-items:center;
      background:rgba(79,124,255,.12); border:1px solid #2b3a7b}
    .kpi__icon span{font-size:20px}
    .kpi__meta{display:flex; flex-direction:column}
    .kpi__value{font-size:22px; font-weight:800; line-height:1.1}
    .kpi__label{font-size:12px; color:var(--muted)}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace, Menlo, Consolas, monospace; letter-spacing:.2px}

    /* Tables */
    .table{
      width:100%; border-collapse:separate; border-spacing:0; font-size:13px;
      border:1px solid var(--line); border-radius:12px; overflow:hidden;
    }
    .table thead th{
      text-align:left; padding:10px 12px; background:#0d142c; color:#cfe0ff; font-weight:700; letter-spacing:.2px;
      border-bottom:1px solid var(--line); position:sticky; top:calc(var(--header-h) + 8px); z-index:1;
      white-space:nowrap;
    }
    .table tbody td{padding:10px 12px; border-bottom:1px solid #14204a; color:#dbe2ff; vertical-align:top}
    .table tbody tr:hover{background:#0e1531}
    .badge{
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:700;
      background:#11193a; border:1px solid #27306a; color:#cfe0ff;
    }
    .badge--ok{background:rgba(34,197,94,.1); border-color:#1a6a45; color:#b6f3cd}

    /* Drawer */
    .drawer{
      position:fixed; top:0; right:-580px; width:580px; max-width:100%; height:100%;
      background:linear-gradient(180deg,#0e1531,#0b1229); border-left:1px solid var(--line);
      box-shadow:-20px 0 40px rgba(0,0,0,.45);
      transition:right .28s ease; z-index:70;
      display:flex; flex-direction:column;
    }
    .drawer.open{right:0}
    .drawer__head{
      padding:14px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .drawer__body{padding:14px 16px; overflow:auto}
    .kv{display:grid; grid-template-columns:170px 1fr; gap:8px 12px; font-size:13px}
    .kv b{color:#bcd0ff; font-weight:700}
    .divider{height:1px; background:var(--line); margin:14px 0}

    /* Footer */
    .footer{opacity:.7; text-align:center; font-size:12px; color:#9aa7d6; margin-top:22px}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
  </style>
</head>
<body>
  <noscript>
    <div style="background:#ffedd5;color:#7c2d12;padding:12px 16px;text-align:center">
      Activez JavaScript pour charger les donn√©es du tableau de bord.
    </div>
  </noscript>

  <!-- Header -->
  <header class="header" role="banner">
    <div class="header__inner">
      <a class="brand" href="#" aria-label="MSGROUPS - Dashboard">
        <img src="https://sergemagdeleinesolutions.fr/logoMsg.png" alt="MSGROUPS" />
        <span class="brand__name">MSGROUPS ‚Ä¢ Dashboard</span>
      </a>
      <div></div>
      <div class="header__actions">
        <button class="btn btn--ghost" id="btnReload" title="Recharger" aria-label="Recharger les donn√©es">‚ü≥ Recharger</button>
        <button class="btn btn--brand" id="btnExport" title="Exporter la vue" aria-label="Exporter la vue en CSV">‚¨á Export CSV</button>
      </div>
    </div>
  </header>

  <main class="wrap" role="main">
    <!-- KPIs -->
    <section aria-labelledby="kpis-title" class="grid grid--kpis">
      <h2 id="kpis-title" class="sr-only">Indicateurs cl√©s</h2>

      <div class="kpi" id="kpiSessionsCard">
        <div class="kpi__icon"><span>üìä</span></div>
        <div class="kpi__meta">
          <div class="kpi__value" id="kpiSessions">‚Äî</div>
          <div class="kpi__label">Sessions (p√©riode)</div>
        </div>
      </div>

      <div class="kpi" id="kpiActiveCard">
        <div class="kpi__icon"><span>‚ö°</span></div>
        <div class="kpi__meta">
          <div class="kpi__value" id="kpiActive">‚Äî</div>
          <div class="kpi__label">Actives (15 derni√®res min)</div>
        </div>
      </div>

      <div class="kpi kpi--ok" id="kpiCTAcard">
        <div class="kpi__icon"><span>‚û°Ô∏è</span></div>
        <div class="kpi__meta">
          <div class="kpi__value">
            <span id="kpiCTA">‚Äî</span>
            <span class="kpi__label" style="margin-left:6px">(taux <span id="kpiCTARate">‚Äî</span>)</span>
          </div>
          <div class="kpi__label">CTA cliqu√©s</div>
        </div>
      </div>

      <!-- Compatibilit√© JS: ex-#kpiMail, renomm√© visuellement -->
      <div class="kpi" id="kpiMailCard">
        <div class="kpi__icon"><span>‚è±Ô∏è</span></div>
        <div class="kpi__meta">
          <div class="kpi__value">
            <span id="kpiMail">‚Äî</span>
            <span class="kpi__label" style="margin-left:6px">(30 min)</span>
          </div>
          <div class="kpi__label">CTA r√©cents (30 min)</div>
        </div>
      </div>
    </section>

    <!-- Filtres -->
    <section class="panel" style="margin-top:14px" aria-labelledby="filters-title">
      <div class="panel__head">
        <div class="panel__title" id="filters-title">Filtres & recherche</div>
        <div class="panel__sub">Affinez les donn√©es affich√©es ci-dessous</div>
      </div>
      <div class="panel__body">
        <div class="grid" style="grid-template-columns:repeat(8,1fr); gap:10px">
          <div class="field">
            <label for="fPeriod">P√©riode</label>
            <select id="fPeriod">
              <option value="today">Aujourd‚Äôhui</option>
              <option value="7d">7 jours</option>
              <option value="30d" selected>30 jours</option>
              <option value="custom">Personnalis√©e‚Ä¶</option>
            </select>
          </div>
          <div class="field">
            <label for="fFrom">Du</label>
            <input type="date" id="fFrom" disabled />
          </div>
          <div class="field">
            <label for="fTo">Au</label>
            <input type="date" id="fTo" disabled />
          </div>

          <div class="field">
            <label for="fUTMsource">UTM Source</label>
            <select id="fUTMsource"><option value="">Toutes</option></select>
          </div>
          <div class="field">
            <label for="fUTMmedium">UTM Medium</label>
            <select id="fUTMmedium"><option value="">Tous</option></select>
          </div>
          <div class="field">
            <label for="fUTMcampaign">UTM Campaign</label>
            <select id="fUTMcampaign"><option value="">Toutes</option></select>
          </div>

          <div class="field">
            <label for="fCountry">Pays</label>
            <select id="fCountry"><option value="">Tous</option></select>
          </div>

          <div class="field" style="grid-column:span 2;">
            <label for="fSearch">Recherche (session, nom, email, WhatsApp)</label>
            <input id="fSearch" type="search" placeholder="Ex: 180203918, Dupont, jean@..., +33..." />
          </div>
          <div class="field" style="align-items:flex-end">
            <button class="btn" id="btnClearFilters">‚Ü∫ R√©initialiser</button>
          </div>
        </div>
      </div>
    </section>

    <!-- LISTE SESSIONS + APER√áUS -->
    <section class="grid grid--wide" style="margin-top:14px">
      <!-- Liste principale -->
      <div class="panel" style="min-width:0">
        <div class="panel__head">
          <div class="panel__title">Sessions (liste)</div>
          <div class="panel__sub"><span id="listCount" class="mono">‚Äî</span> affich√©es ‚Ä¢ double-clic pour d√©tails</div>
        </div>
        <div class="panel__body" style="padding:0">
          <div style="overflow:auto; max-height:65vh;">
            <table class="table" id="sessionsTable" aria-label="Table des sessions">
              <thead>
                <tr>
                  <th>Session</th>
                  <th>Ouverture</th>
                  <th>Acquisition</th>
                  <th>Pays / Ville</th>
                  <th>Device</th>
                  <th>CTA</th>
                  <th>Dernier √©v√®nement</th>
                  <th>MAJ</th>
                </tr>
              </thead>
              <tbody>
                <tr class="placeholder">
                  <td class="mono">‚Äî</td>
                  <td>‚Äî</td>
                  <td><span class="muted">utm_source/medium/campaign</span></td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                  <td><span class="badge">‚Äî</span></td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Aper√ßus rapides -->
      <div class="grid grid--three" style="min-width:0">
        <div class="panel">
          <div class="panel__head">
            <div class="panel__title">Funnel & compl√©tion</div>
            <div class="panel__sub">% par √©tape et conversion CTA</div>
          </div>
          <div class="panel__body">
            <div class="badge" id="chartFunnel" style="display:block; text-align:center; padding:24px">‚Äî</div>
          </div>
        </div>

        <div class="panel">
          <div class="panel__head">
            <div class="panel__title">Devices / OS / Navigateur</div>
            <div class="panel__sub">R√©partition</div>
          </div>
          <div class="panel__body">
            <div class="badge" id="chartDevices" style="display:block; text-align:center; padding:24px">‚Äî</div>
          </div>
        </div>

        <div class="panel">
          <div class="panel__head">
            <div class="panel__title">G√©ographie</div>
            <div class="panel__sub">Sessions par pays</div>
          </div>
          <div class="panel__body">
            <div class="badge" id="chartGeo" style="display:block; text-align:center; padding:24px">‚Äî</div>
          </div>
        </div>

        <div class="panel" style="grid-column:span 3;">
          <div class="panel__head">
            <div class="panel__title">Performance acquisition (UTM & referrers)</div>
            <div class="panel__sub">Classements</div>
          </div>
          <div class="panel__body">
            <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
              <div>
                <h3 class="panel__title" style="margin:0 0 8px 0">UTM (source / medium / campaign)</h3>
                <div style="overflow:auto; max-height:260px; border:1px solid var(--line); border-radius:12px">
                  <table class="table" id="utmTable">
                    <thead>
                      <tr>
                        <th>UTM</th>
                        <th>Sessions</th>
                        <th>CTA</th>
                        <th>Conv.</th>
                        <th>‚Äî</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr class="placeholder">
                        <td class="mono muted">utm_source / utm_medium / utm_campaign</td>
                        <td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div>
                <h3 class="panel__title" style="margin:0 0 8px 0">Referrers</h3>
                <div style="overflow:auto; max-height:260px; border:1px solid var(--line); border-radius:12px">
                  <table class="table" id="refTable">
                    <thead>
                      <tr>
                        <th>Referrer</th>
                        <th>Sessions</th>
                        <th>CTA</th>
                        <th>‚Äî</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr class="placeholder">
                        <td class="muted">‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- CTA r√©cents (30 min) & sant√© -->
    <section class="grid grid--two" style="margin-top:14px">
      <div class="panel">
        <div class="panel__head">
          <div class="panel__title">CTA r√©cents (&lt; 30 min)</div>
          <div class="panel__sub">Suivi rapide des sessions ayant cliqu√© un CTA</div>
        </div>
        <div class="panel__body">
          <table class="table" id="queueTable" aria-label="CTA r√©cents">
            <thead>
              <tr>
                <th>Session</th>
                <th>CTA</th>
                <th>√âch√©ance</th>
                <th>Statut</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr class="placeholder">
                <td class="mono">‚Äî</td>
                <td>‚Äî</td>
                <td>‚Äî</td>
                <td><span class="badge">‚Äî</span></td>
                <td><button class="btn" disabled>Rechecker</button></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <div class="panel__head">
          <div class="panel__title">√âtat</div>
          <div class="panel__sub">Qualit√© & int√©grit√© des donn√©es</div>
        </div>
        <div class="panel__body">
          <ul id="alertsList" style="list-style:none; padding:0; margin:0; display:grid; gap:10px">
            <li class="badge">V√©rification en cours‚Ä¶</li>
          </ul>
          <div class="divider"></div>
          <div class="kv">
            <b>Derni√®re synchro</b><span id="lastSync" class="mono muted">‚Äî</span>
            <b>Erreurs ingestion</b><span id="ingestionErrors" class="mono muted">0</span>
          </div>
        </div>
      </div>
    </section>

    <p class="footer">¬© 2025 MSGROUPS ‚Äî Dashboard interne (Google Sheets). Double-clic sur une ligne pour voir tous les champs.</p>
  </main>

  <!-- Drawer: D√©tails complets -->
  <aside class="drawer" id="sessionDrawer" aria-labelledby="drawer-title" aria-hidden="true">
    <div class="drawer__head">
      <div>
        <div class="panel__title" id="drawer-title" style="margin-bottom:2px">D√©tails session</div>
        <div class="panel__sub mono" id="drawerSessionId">session_id: ‚Äî</div>
      </div>
      <button class="btn" id="drawerClose" aria-label="Fermer">‚úï</button>
    </div>
    <div class="drawer__body">
      <div class="panel__title" style="margin-bottom:8px">Identit√©</div>
      <div class="kv">
        <b>Ouverture</b><span id="d_ts_open" class="mono">‚Äî</span>
        <b>Dernier √©v√®nement</b><span id="d_last_event" class="mono">‚Äî</span>
        <b>MAJ</b><span id="d_ts_update" class="mono">‚Äî</span>
      </div>

      <div class="divider"></div>

      <div class="panel__title" style="margin-bottom:8px">Acquisition</div>
      <div class="kv">
        <b>Referrer</b><span id="d_referrer" class="mono">‚Äî</span>
        <b>Landing</b><span id="d_landing" class="mono">‚Äî</span>
        <b>UTM</b><span id="d_utm" class="mono">‚Äî</span>
        <b>CTA</b><span id="d_cta_label">‚Äî</span>
        <b>Horodatage CTA</b><span id="d_ts_cta" class="mono">‚Äî</span>
      </div>

      <div class="divider"></div>

      <div class="panel__title" style="margin-bottom:8px">Contexte</div>
      <div class="kv">
        <b>Localisation</b><span id="d_geo">‚Äî</span>
        <b>Device</b><span id="d_device">‚Äî</span>
        <b>OS / Navigateur</b><span id="d_os_browser">‚Äî</span>
        <b>User Agent</b><span id="d_user_agent" class="mono">‚Äî</span>
        <b>√âcran total</b><span id="d_screen_total" class="mono">‚Äî</span>
        <b>Viewport</b><span id="d_screen" class="mono">‚Äî</span>
        <b>Langue / TZ</b><span id="d_lang_tz" class="mono">‚Äî</span>
      </div>

      <div class="divider"></div>

      <div class="panel__title" style="margin-bottom:8px">Formulaire (snapshot)</div>
      <div class="kv">
        <b>Pr√©nom / Nom</b><span id="d_name">‚Äî</span>
        <b>Email</b><span id="d_email" class="mono">‚Äî</span>
        <b>WhatsApp</b><span id="d_whatsapp" class="mono">‚Äî</span>
        <b>Pays / Naissance</b><span id="d_pays_naiss" class="mono">‚Äî</span>
        <b>Montant / Dur√©e</b><span id="d_montant_duree" class="mono">‚Äî</span>
        <b>Raison</b><span id="d_raison">‚Äî</span>
        <b>Statut / Revenus</b><span id="d_statut_revenus" class="mono">‚Äî</span>
        <b>Pi√®ces</b><span id="d_pieces" class="mono">‚Äî</span>
      </div>

      <div class="divider"></div>

      <div class="panel__title" style="margin-bottom:8px">Timeline</div>
      <div class="timeline" id="d_timeline">
        <div class="badge" style="display:inline-block">‚Äî</div>
      </div>
    </div>
  </aside>

  <!-- JS bootstrapping -->
  <script>
    // Config CSV publique (facultatif si d√©j√† d√©fini dans dashboard.js)
    window.DASHBOARD_CONFIG = Object.assign({}, window.DASHBOARD_CONFIG || {}, {
      SHEET_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8Arza8xo4v4MNQA8cocGmQ7AHVj1yrj0ZBRjWSmbi33w1Sc24uI521xfZdwXon3nEzpo3S35A5kGO/pub?gid=70713818&single=true&output=csv'
    });

    // Fermeture du drawer (la logique de donn√©es est dans dashboard.js)
    (function(){
      const drawer = document.getElementById('sessionDrawer');
      const closeBtn = document.getElementById('drawerClose');
      if(closeBtn){
        closeBtn.addEventListener('click', ()=>{
          drawer.classList.remove('open');
          drawer.setAttribute('aria-hidden','true');
        });
      }
    })();
  </script>

  <!-- Logique donn√©es/rendu -->
  <script src="dashboard.js" defer></script>

  <!-- Ajustement mineur d‚Äôaffichage pour last_event / ts_last_update dans la liste -->
  <script>
    // Ce petit hook compl√®te la ligne de la table une fois que dashboard.js a inject√© les rang√©es essentielles.
    // Il observe les ajouts et comble les colonnes "Dernier √©v√®nement" et "MAJ" depuis le drawer data attribuable.
    new MutationObserver(() => {
      const rows = document.querySelectorAll('#sessionsTable tbody tr[data-session-id]');
      rows.forEach(tr => {
        const sid = tr.getAttribute('data-session-id') || '';
        // dashboard.js n‚Äôattache pas les objets ici, on laisse la colonne telle quelle (remplie plus tard si tu veux √©tendre dashboard.js).
        // Par d√©faut, les deux derni√®res colonnes sont vides dans le markup initial,
        // mais resteront utiles visuellement quand tu √©tendras le remplissage.
      });
    }).observe(document.querySelector('#sessionsTable tbody'), { childList:true });
  </script>
</body>
</html>

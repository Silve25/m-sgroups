<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MSGROUPS — Sessions Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0b0f14;--card:#121821;--muted:#9fb0c3;--text:#e8f0f7;--brand:#4f46e5;--ok:#16a34a;--warn:#f59e0b;--danger:#ef4444;--border:#223042;--chip:#182131}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b0f14, #0c1118 70%);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:12px}
    .title{display:flex;align-items:center;gap:12px}
    .title h1{font-size:18px;margin:0}
    .tag{background:var(--chip);border:1px solid var(--border);color:var(--muted);padding:2px 8px;border-radius:999px;font-size:12px}
    .actions{display:flex;gap:8px}
    button, select, input, .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:10px;padding:8px 12px;font-size:14px}
    button:hover,.btn:hover{border-color:#314257}
    .brand{background:var(--brand);border-color:transparent}

    .grid{display:grid;gap:12px}
    .grid.kpi{grid-template-columns:repeat(5,1fr)}
    .grid.two{grid-template-columns:1fr 1fr}
    .grid.four{grid-template-columns:1fr 1fr}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
    .kpi h3{margin:0 0 6px 0;font-size:12px;color:var(--muted);font-weight:500}
    .kpi .big{font-size:22px;font-weight:700}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;flex-wrap:wrap}

    .filters .row>div{display:flex;flex-direction:column;gap:6px;min-width:140px;flex:1}
    .filters label{font-size:12px;color:var(--muted)}

    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:var(--card);z-index:1}
    th,td{border-bottom:1px dashed var(--border);padding:8px;text-align:left;font-size:13px}
    tbody tr:hover{background:#0f1620}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#0f172a;border:1px solid #223042;border-radius:8px;padding:2px 8px;font-size:12px}
    .badge--ok{background:#062714;border-color:#214a2f;color:#9ef5b3}
    .badge--warn{background:#271a06;border-color:#4a3a21;color:#f7d085}

    .charts canvas{width:100% !important; height:260px !important}

    .drawer{position:fixed;inset:0;background:rgba(3,7,12,.55);display:none}
    .drawer.open{display:block}
    .drawer__panel{position:absolute;right:0;top:0;bottom:0;width:100%;max-width:420px;background:var(--card);border-left:1px solid var(--border);padding:16px;overflow:auto}

    .sticky-actions{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:12px 0}

    @media (max-width:1000px){
      .grid.kpi{grid-template-columns:repeat(2,1fr)}
      .grid.two,.grid.four{grid-template-columns:1fr}
      header{align-items:flex-start;gap:8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 12h14M5 7h14M5 17h7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" /></svg>
        <h1>MSGROUPS — Sessions Dashboard</h1>
        <span class="tag" id="lastSync">…</span>
      </div>
      <div class="actions">
        <button id="btnReload" class="btn">Recharger</button>
        <button id="btnExport" class="btn">Exporter (CSV)</button>
      </div>
    </header>

    <!-- KPIs étendus -->
    <section class="grid kpi">
      <div class="card kpi"><h3>Ouvertures (sessions)</h3><div class="big" id="kpiSessions">—</div></div>
      <div class="card kpi"><h3>Formulaires remplis</h3><div class="big"><span id="kpiForms">—</span> <span class="muted" id="kpiFormsRate">—</span></div></div>
      <div class="card kpi"><h3>Conversions (CTA)</h3><div class="big"><span id="kpiConv">—</span> <span class="muted" id="kpiConvRate">—</span></div></div>
      <div class="card kpi"><h3>Actives (≤15 min)</h3><div class="big" id="kpiActive">—</div></div>
      <div class="card kpi"><h3>CTR global</h3><div class="big" id="kpiCTARate">—</div></div>
    </section>

    <!-- Filtres -->
    <section class="card filters" style="margin-top:12px">
      <div class="row">
        <div><label>Période</label>
          <select id="fPeriod">
            <option value="today">Aujourd'hui</option>
            <option value="7d">7 jours</option>
            <option value="30d" selected>30 jours</option>
            <option value="custom">Personnalisée</option>
          </select>
        </div>
        <div><label>Du</label><input id="fFrom" type="date" disabled></div>
        <div><label>Au</label><input id="fTo" type="date" disabled></div>
        <div><label>UTM source</label><select id="fUTMsource"><option value="">Toutes</option></select></div>
        <div><label>UTM medium</label><select id="fUTMmedium"><option value="">Tous</option></select></div>
        <div><label>UTM campaign</label><select id="fUTMcampaign"><option value="">Toutes</option></select></div>
        <div><label>Pays</label><select id="fCountry"><option value="">Tous</option></select></div>
        <div><label>Device (groupe)</label>
          <select id="fDevice"><option value="">Tous</option><option value="android">Android</option><option value="iphone">iPhone</option><option value="tablet">Tablette</option><option value="pc">PC</option><option value="autre">Autre</option></select>
        </div>
        <div><label>CTA</label><select id="fCTA"><option value="">Tous</option><option value="clicked">Cliqué</option><option value="not">Non cliqué</option></select></div>
        <div style="min-width:220px"><label>Recherche</label><input id="fSearch" type="search" placeholder="email, prénom, ville…"></div>
        <div style="align-self:flex-end"><button id="btnClearFilters">Réinitialiser</button></div>
      </div>
    </section>

    <!-- Graphiques -->
    <section class="grid four" style="margin-top:12px">
      <div class="card charts">
        <div class="sticky-actions"><strong>CTA cliqués par jour</strong><span class="muted">Ligne (clics/temps)</span></div>
        <canvas id="cClicksTime"></canvas>
      </div>
      <div class="card charts">
        <div class="sticky-actions"><strong>Sessions par jour</strong><span class="muted">Ligne</span></div>
        <canvas id="cSessionsTime"></canvas>
      </div>
      <div class="card charts">
        <div class="sticky-actions"><strong>Répartition par device</strong><span class="muted" id="chartFunnel">—</span></div>
        <canvas id="cDevices"></canvas>
      </div>
      <div class="card charts">
        <div class="sticky-actions"><strong>Top referrers</strong><span class="muted">Top 7</span></div>
        <canvas id="cReferrers"></canvas>
      </div>
    </section>

    <!-- UTM / Referrer tables -->
    <section class="grid two" style="margin-top:12px">
      <div class="card">
        <div class="sticky-actions"><strong>UTM breakdown</strong><span class="muted">Sessions · CTA · CTR</span></div>
        <div style="overflow:auto; max-height:360px">
          <table id="utmTable">
            <thead><tr><th class="mono">utm_source / utm_medium / utm_campaign</th><th>Sessions</th><th>CTA</th><th>CTR</th></tr></thead>
            <tbody><tr><td colspan="4" class="muted">—</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="sticky-actions"><strong>Referrers (table)</strong><span class="muted">Sessions · CTA</span></div>
        <div style="overflow:auto; max-height:360px">
          <table id="refTable">
            <thead><tr><th>Referrer</th><th>Sessions</th><th>CTA</th></tr></thead>
            <tbody><tr><td colspan="3" class="muted">—</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Liste sessions -->
    <section class="card" style="margin-top:12px">
      <div class="sticky-actions">
        <strong>Sessions (<span id="listCount">0</span>)</strong>
        <span class="muted">Double‑tap pour les détails</span>
      </div>
      <div style="overflow:auto; max-height:420px">
        <table id="sessionsTable">
          <thead>
            <tr>
              <th>Session</th><th>Ouverture</th><th>Acquisition</th><th>Géo</th><th>Device</th><th>CTA</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Mini contacts -->
    <section class="card" style="margin-top:12px">
      <div class="sticky-actions"><strong>Contacts (essentiel)</strong><span class="muted">Nom · Prénom · Numéro · Ville · Email · CTA</span></div>
      <div style="overflow:auto; max-height:360px">
        <table id="miniTable">
          <thead><tr><th>Nom</th><th>Prénom</th><th>Numéro</th><th>Ville</th><th>Email</th><th>CTA</th></tr></thead>
          <tbody><tr><td colspan="6" class="muted">—</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Alertes -->
    <section class="card" style="margin-top:12px">
      <div class="sticky-actions"><strong>Alertes d’ingestion</strong></div>
      <ul id="alertsList" style="margin:0;padding:0;display:flex;gap:8px;flex-wrap:wrap;list-style:none">
        <li class="pill">…</li>
      </ul>
    </section>
  </div>

  <!-- Drawer details -->
  <div class="drawer" id="sessionDrawer" aria-hidden="true">
    <div class="drawer__panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <strong id="drawerSessionId">session_id: —</strong>
        <button class="btn" onclick="closeDrawer()">Fermer</button>
      </div>
      <div class="grid two" style="margin-top:12px">
        <div class="card"><div class="muted">Ouverture</div><div id="d_ts_open">—</div></div>
        <div class="card"><div class="muted">Dernière maj</div><div id="d_ts_update">—</div></div>
      </div>

      <div class="grid two" style="margin-top:12px">
        <div class="card"><div class="muted">Referrer / Landing</div><div id="d_referrer">—</div><div id="d_landing" class="mono">—</div></div>
        <div class="card"><div class="muted">UTM</div><div id="d_utm" class="mono">—</div></div>
      </div>

      <div class="grid two" style="margin-top:12px">
        <div class="card"><div class="muted">Géo</div><div id="d_geo">—</div></div>
        <div class="card"><div class="muted">Device</div><div id="d_device">—</div><div id="d_os_browser" class="muted">—</div><div id="d_screen" class="muted">—</div><div id="d_lang_tz" class="muted">—</div></div>
      </div>

      <div class="grid two" style="margin-top:12px">
        <div class="card"><div class="muted">Contact</div><div id="d_name">—</div><div id="d_email" class="mono">—</div><div id="d_whatsapp" class="mono">—</div></div>
        <div class="card"><div class="muted">Formulaire</div><div id="d_pays_naiss">—</div><div id="d_montant_duree">—</div><div id="d_raison">—</div><div id="d_statut_revenus">—</div><div id="d_pieces">—</div></div>
      </div>

      <div class="grid two" style="margin-top:12px">
        <div class="card"><div class="muted">CTA</div><div id="d_cta_label">—</div><div id="d_ts_cta" class="muted">—</div></div>
        <div class="card"><div class="muted">État email</div><div id="d_mail_state">—</div></div>
      </div>
    </div>
  </div>

<script>
/* ================================
 * MSGROUPS — dashboard v2 (one‑file)
 * Lit la feuille "sessions" via l'URL CSV publiée
 * ================================ */
(() => {
  const CSV_URL_DEFAULT = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8Arza8xo4v4MNQA8cocGmQ7AHVj1yrj0ZBRjWSmbi33w1Sc24uI521xfZdwXon3nEzpo3S35A5kGO/pub?gid=70713818&single=true&output=csv';
  const CFG = { SHEET_CSV_URL: (typeof window!=='undefined' && window.DASHBOARD_CONFIG && window.DASHBOARD_CONFIG.SHEET_CSV_URL) || CSV_URL_DEFAULT };

  const COLS = ['session_id','ts_open','referrer','landing_url','utm_source','utm_medium','utm_campaign','country','city','device_type','os','browser','user_agent','screen_width','screen_height','viewport_width','viewport_height','device_pixel_ratio','language','timezone_offset_min','form_prenom','form_nom','form_email','form_whatsapp','form_pays','form_date_naissance','form_montant_eur','form_duree_mois','form_raison','form_statut','form_revenus','form_pieces','cta_clicked','cta_label','ts_cta','last_event','ts_last_update'];

  const $ = (sel, root=document) => root.querySelector(sel);
  const el = (tag, attrs={}) => { const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>k==='text'?n.textContent=v:k==='html'?n.innerHTML=v:n.setAttribute(k,v)); return n };

  let RAW_ROWS=[];
  let FILTERS={ period:'30d', from:null, to:null, utm_source:'', utm_medium:'', utm_campaign:'', country:'', device:'', cta:'', search:'' };

  // CSV helpers
  async function fetchCsvText(){ const res=await fetch(CFG.SHEET_CSV_URL); if(!res.ok) throw new Error('CSV non disponible. Vérifie la publication.'); return await res.text(); }
  function parseCSV(text){ const rows=[]; let i=0, field='', row=[], inQ=false; while(i<text.length){ const c=text[i]; if(inQ){ if(c==='"'){ if(text[i+1]==='"'){ field+='"'; i+=2; continue;} inQ=false; i++; continue;} field+=c; i++; continue;} else { if(c==='"'){ inQ=true; i++; continue;} if(c===','){ row.push(field); field=''; i++; continue;} if(c==='\r'){ i++; continue;} if(c==='\n'){ row.push(field); rows.push(row); field=''; row=[]; i++; continue;} field+=c; i++; }} row.push(field); rows.push(row); return rows; }
  const normalizeHeaderKey = (k)=>String(k||'').trim().toLowerCase().replace(/\s+/g,'_');
  function cleanTypes(o){ const asNumber=v=>{ if(v==null||v==='') return ''; const n=Number(String(v).replace(',','.')); return isFinite(n)?n:''}; const asBool=v=>{ const s=String(v).trim().toLowerCase(); return (s==='true'||s==='1'||s==='oui'||s==='yes')}; ['timezone_offset_min','screen_width','screen_height','viewport_width','viewport_height','device_pixel_ratio','form_montant_eur','form_duree_mois'].forEach(k=>o[k]=asNumber(o[k])); o['cta_clicked']=asBool(o['cta_clicked']); return o }
  function mapCsvToObjects(rows2d){ if(!rows2d||!rows2d.length) return []; const header=rows2d[0].map(h=>String(h||'').trim()); const idxByHeader=new Map(); header.forEach((h,i)=>idxByHeader.set(h,i)); const idxByNorm=new Map(); header.forEach((h,i)=>idxByNorm.set(normalizeHeaderKey(h),i)); const out=[]; for(let r=1;r<rows2d.length;r++){ const row=rows2d[r]; if(!row||row.length===0) continue; const obj={}; COLS.forEach(col=>{ let i=idxByHeader.get(col); if(typeof i!=="number") i = idxByNorm.get(normalizeHeaderKey(col)); obj[col]=(typeof i==="number")?row[i]:''; }); out.push(cleanTypes(obj)); } return out }

  const fmtDate = (iso)=>{ if(!iso) return '—'; try{ const d=new Date(iso); if(isNaN(d)) return String(iso); return d.toLocaleString(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) } catch { return String(iso) } };
  const dayKey = (iso)=>{ try{ const d=new Date(iso); if(isNaN(d)) return null; return d.toISOString().slice(0,10);}catch{return null} };
  const truthy = (v)=> v===true||v==='true'||v===1||v==='1';

  // Device grouping
  function deriveDeviceGroup(r){ const ua=(r.user_agent||'').toLowerCase(); const dev=(r.device_type||'').toLowerCase(); if(/iphone|ipod/.test(ua)) return 'iphone'; if(/ipad/.test(ua)) return 'tablet'; if(/android/.test(ua)) return /mobile/.test(ua)?'android':'tablet'; if(/windows|macintosh|linux|x11/.test(ua)) return 'pc'; if(dev==='desktop') return 'pc'; if(dev==='tablet') return 'tablet'; if(dev==='mobile') return 'android'; return 'autre'; }

  // Business metrics
  const isFormFilled = (r)=> !!(r.form_email || r.form_whatsapp || r.form_prenom || r.form_nom);

  // Filters
  function applyFilters(rows){ const {period,from,to,utm_source,utm_medium,utm_campaign,country,device,cta,search}=FILTERS; let df=rows.slice();
    // période
    let start=null,end=null; const today=new Date(); end=new Date(today); end.setHours(23,59,59,999);
    if(period==='today'){ start=new Date(today); start.setHours(0,0,0,0);} else if(period==='7d'){ start=new Date(today.getTime()-6*86400000); start.setHours(0,0,0,0);} else if(period==='30d'){ start=new Date(today.getTime()-29*86400000); start.setHours(0,0,0,0);} else if(period==='custom'&&from&&to){ start=new Date(from); end=new Date(to); end.setHours(23,59,59,999);} 
    if(start){ df=df.filter(r=>{ const t=r.ts_open?new Date(r.ts_open):null; return t&&t>=start&&t<=end; }); }
    if(utm_source) df=df.filter(r=>(r.utm_source||'')===utm_source);
    if(utm_medium) df=df.filter(r=>(r.utm_medium||'')===utm_medium);
    if(utm_campaign) df=df.filter(r=>(r.utm_campaign||'')===utm_campaign);
    if(country) df=df.filter(r=>(r.country||'')===country);
    if(device) df=df.filter(r=> (r._dev_group||deriveDeviceGroup(r))===device);
    if(cta==='clicked') df=df.filter(r=>truthy(r.cta_clicked));
    if(cta==='not') df=df.filter(r=>!truthy(r.cta_clicked));
    if(search){ const q=search.toLowerCase(); df=df.filter(r=>[r.session_id,r.form_prenom,r.form_nom,r.form_email,r.form_whatsapp,r.city,r.country].some(v=>String(v||'').toLowerCase().includes(q))); }
    return df;
  }

  function computeKPIs(df){ const total=df.length; const forms=df.filter(isFormFilled).length; const conv=df.filter(r=>truthy(r.cta_clicked)).length; const ctrGlobal = total? (conv/total)*100:0; const formRate = total? (forms/total)*100:0; const convRate = total? (conv/total)*100:0; const active=df.filter(r=>{ const t=r.ts_last_update?new Date(r.ts_last_update):null; return t && ((Date.now()-t.getTime())/60000)<=15; }).length; return {total,forms,conv,ctrGlobal,formRate,convRate,active}; }

  // Charts
  let cClicksTime, cSessionsTime, cDevices, cReferrers;
  function drawCharts(df){
    // Clicks per day
    const clicksByDay=new Map();
    df.filter(r=>truthy(r.cta_clicked) && r.ts_cta).forEach(r=>{ const k=dayKey(r.ts_cta); if(!k) return; clicksByDay.set(k,(clicksByDay.get(k)||0)+1); });
    const sessionsByDay=new Map();
    df.forEach(r=>{ const k=dayKey(r.ts_open); if(!k) return; sessionsByDay.set(k,(sessionsByDay.get(k)||0)+1); });
    const sortedDays=[...new Set([...sessionsByDay.keys(),...clicksByDay.keys()])].sort();

    if(cClicksTime) cClicksTime.destroy();
    cClicksTime=new Chart($('#cClicksTime'),{type:'line',data:{labels:sortedDays,datasets:[{label:'CTA cliqués',data:sortedDays.map(d=>clicksByDay.get(d)||0)}]},options:{plugins:{legend:{display:true,position:'bottom'}},scales:{y:{beginAtZero:true}},maintainAspectRatio:false}});

    if(cSessionsTime) cSessionsTime.destroy();
    cSessionsTime=new Chart($('#cSessionsTime'),{type:'line',data:{labels:sortedDays,datasets:[{label:'Sessions',data:sortedDays.map(d=>sessionsByDay.get(d)||0)}]},options:{plugins:{legend:{display:true,position:'bottom'}},scales:{y:{beginAtZero:true}},maintainAspectRatio:false}});

    // Devices doughnut (grouped)
    const byDevice=new Map(); df.forEach(r=>{ const k=r._dev_group||deriveDeviceGroup(r); byDevice.set(k,(byDevice.get(k)||0)+1)});
    if(cDevices) cDevices.destroy();
    cDevices=new Chart($('#cDevices'),{type:'doughnut',data:{labels:[...byDevice.keys()],datasets:[{data:[...byDevice.values()]}]},options:{plugins:{legend:{display:true,position:'bottom'}},maintainAspectRatio:false,cutout:'60%'}});

    // Referrers bar
    const refMap=new Map(); df.forEach(r=>{ const k=r.referrer||'—'; refMap.set(k,(refMap.get(k)||0)+1); });
    const topRef=[...refMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0,7);
    if(cReferrers) cReferrers.destroy();
    cReferrers=new Chart($('#cReferrers'),{type:'bar',data:{labels:topRef.map(x=>x[0]),datasets:[{label:'Sessions',data:topRef.map(x=>x[1])}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}},maintainAspectRatio:false}});

    $('#chartFunnel').textContent = `Sessions: ${df.length} • CTA: ${df.filter(r=>truthy(r.cta_clicked)).length}`;
  }

  function renderFiltersOptions(rows){ const uniq = arr => Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b)));
    const setOpts = (sel, values, allLabel='Tous/Toutes') => { const elSel=$(sel); if(!elSel) return; const current=elSel.value; elSel.innerHTML=''; const first=el('option',{value:''}); first.textContent=allLabel; elSel.appendChild(first); values.forEach(v=>{ const o=el('option',{value:String(v)}); o.textContent=String(v); elSel.appendChild(o)}); if(current && values.includes(current)) elSel.value=current; };
    setOpts('#fUTMsource',uniq(rows.map(r=>r.utm_source)),'Toutes');
    setOpts('#fUTMmedium',uniq(rows.map(r=>r.utm_medium)),'Tous');
    setOpts('#fUTMcampaign',uniq(rows.map(r=>r.utm_campaign)),'Toutes');
    setOpts('#fCountry',uniq(rows.map(r=>r.country)),'Tous');
  }

  function renderKPIs(k){
    $('#kpiSessions').textContent=k.total.toString();
    $('#kpiActive').textContent=k.active.toString();
    $('#kpiCTARate').textContent= `${k.ctrGlobal.toFixed(1)}%`;
    $('#kpiForms').textContent=k.forms.toString();
    $('#kpiFormsRate').textContent=`(${k.formRate.toFixed(1)}%)`;
    $('#kpiConv').textContent=k.conv.toString();
    $('#kpiConvRate').textContent=`(${k.convRate.toFixed(1)}%)`;
  }

  function renderAcquisition(df){
    const utmMap=new Map();
    df.forEach(r=>{ const key=`${r.utm_source||''} / ${r.utm_medium||''} / ${r.utm_campaign||''}`; if(!utmMap.has(key)) utmMap.set(key,{s:0,c:0}); const obj=utmMap.get(key); obj.s+=1; if(truthy(r.cta_clicked)) obj.c+=1; });
    const tbody=$('#utmTable tbody'); tbody.innerHTML=''; if(!utmMap.size){ tbody.innerHTML='<tr><td colspan="4" class="muted">—</td></tr>'; } else {
      [...utmMap.entries()].sort((a,b)=>b[1].s-a[1].s).forEach(([k,v])=>{ const tr=el('tr'); const ctr=v.s?(v.c/v.s*100).toFixed(1)+'%':'0.0%'; tr.innerHTML=`<td class="mono">${k}</td><td>${v.s}</td><td>${v.c}</td><td>${ctr}</td>`; tbody.appendChild(tr); }); }

    const refMap=new Map(); df.forEach(r=>{ const key=r.referrer||'—'; if(!refMap.has(key)) refMap.set(key,{s:0,c:0}); const obj=refMap.get(key); obj.s+=1; if(truthy(r.cta_clicked)) obj.c+=1; });
    const rbody=$('#refTable tbody'); rbody.innerHTML=''; if(!refMap.size){ rbody.innerHTML='<tr><td colspan="3" class="muted">—</td></tr>'; } else {
      [...refMap.entries()].sort((a,b)=>b[1].s-a[1].s).forEach(([k,v])=>{ const tr=el('tr'); tr.innerHTML=`<td>${k}</td><td>${v.s}</td><td>${v.c}</td>`; rbody.appendChild(tr); }); }
  }

  function renderSessionsTable(df){ const tbody=$('#sessionsTable tbody'); tbody.innerHTML=''; $('#listCount').textContent=String(df.length);
    df.forEach(r=>{ const tr=el('tr',{ 'data-session-id': r.session_id||'' });
      const tdSession=el('td',{ html:`<span class="mono">${r.session_id||'—'}</span>`});
      const tdOpen=el('td',{ text: fmtDate(r.ts_open)});
      const tdAcq=el('td',{ html:`<span class="muted">${r.utm_source||'—'}/${r.utm_medium||'—'}/${r.utm_campaign||'—'}</span>`});
      const tdGeo=el('td',{ text:`${r.country||'—'}${r.city?' / '+r.city:''}`});
      const tdDevice=el('td',{ text:`${(r._dev_group||deriveDeviceGroup(r)).toUpperCase()} (${r.os||'?'} / ${r.browser||'?'})`});
      const tdCTA=el('td',{ html: truthy(r.cta_clicked) ? `<span class="badge badge--ok">${r.cta_label||'Cliqué'}</span>` : `<span class="badge">—</span>`});
      tr.append(tdSession,tdOpen,tdAcq,tdGeo,tdDevice,tdCTA);
      tr.addEventListener('dblclick',()=>openDrawer(r));
      tbody.appendChild(tr);
    });
  }

  function renderMiniTable(df){ const tb = $('#miniTable tbody'); if(!tb) return; tb.innerHTML=''; if(!df.length){ tb.innerHTML='<tr><td colspan="6" class="muted">—</td></tr>'; return;} df.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${r.form_nom||'—'}</td><td>${r.form_prenom||'—'}</td><td class="mono">${r.form_whatsapp||'—'}</td><td>${r.city||'—'}</td><td class="mono">${r.form_email||'—'}</td><td>${truthy(r.cta_clicked)?'<span class="badge badge--ok">Cliqué</span>':'<span class="badge">Non</span>'}</td>`; tb.appendChild(tr); }); }

  function computeEmailState(row){ if(truthy(row.cta_clicked)){ const ts=row.ts_cta?new Date(row.ts_cta):null; if(ts){ const diffMin=(Date.now()-ts.getTime())/60000; if(diffMin<=30) return {label:'En attente',cls:'badge'}; } return {label:'Non reçu',cls:'badge badge--warn'}; } return {label:'—',cls:'badge'} }

  function openDrawer(r){ $('#drawerSessionId').textContent=`session_id: ${r.session_id||'—'}`; $('#d_ts_open').textContent=fmtDate(r.ts_open); $('#d_ts_update').textContent=fmtDate(r.ts_last_update); $('#d_referrer').textContent=r.referrer||'—'; $('#d_landing').textContent=r.landing_url||'—'; $('#d_utm').textContent=`${r.utm_source||'—'}/${r.utm_medium||'—'}/${r.utm_campaign||'—'}`; $('#d_geo').textContent=`${r.country||'—'}${r.city?' / '+r.city:''}`; $('#d_device').textContent=(r._dev_group||deriveDeviceGroup(r)).toUpperCase(); $('#d_os_browser').textContent=`${r.os||'—'} / ${r.browser||'—'}`; $('#d_screen').textContent=`${r.viewport_width||'—'}×${r.viewport_height||'—'} @${r.device_pixel_ratio||'—'}`; $('#d_lang_tz').textContent=`${r.language||'—'} / ${r.timezone_offset_min||'—'} min`; $('#d_name').textContent=`${r.form_prenom||'—'} ${r.form_nom||''}`.trim(); $('#d_email').textContent=r.form_email||'—'; $('#d_whatsapp').textContent=r.form_whatsapp||'—'; $('#d_pays_naiss').textContent=`${r.form_pays||'—'}${r.form_date_naissance?' / '+r.form_date_naissance:''}`; $('#d_montant_duree').textContent=`${r.form_montant_eur||'—'} € / ${r.form_duree_mois||'—'} mois`; $('#d_raison').textContent=r.form_raison||'—'; $('#d_statut_revenus').textContent=`${r.form_statut||'—'} / ${r.form_revenus||'—'}`; $('#d_pieces').textContent=r.form_pieces||'—'; $('#d_cta_label').textContent= truthy(r.cta_clicked)?(r.cta_label||'Cliqué'):'—'; $('#d_ts_cta').textContent=fmtDate(r.ts_cta); const mail=computeEmailState(r); $('#d_mail_state').innerHTML=`<span class="${mail.cls}">${mail.label}</span>`; const drawer=$('#sessionDrawer'); drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); }
  window.closeDrawer = ()=>{ const d=$('#sessionDrawer'); d.classList.remove('open'); d.setAttribute('aria-hidden','true'); };

  function exportCSV(rows){ if(!rows||!rows.length) return; const header=COLS.join(','); const esc=v=>{ const s=v==null?'':String(v); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s}; const lines=rows.map(r=>COLS.map(c=>esc(r[c])).join(',')); const csv=[header,...lines].join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=el('a',{href:url,download:`msgroups_dashboard_${Date.now()}.csv`}); document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove(); }

  function renderAlerts(ok,msg=''){ $('#lastSync').textContent=new Date().toLocaleString(); const list=$('#alertsList'); list.innerHTML=''; if(ok){ list.innerHTML=`<li class="pill" style="background:#041620;border-color:#0c2b43;color:#7fc1ff">Aucune alerte active</li>`; } else { list.innerHTML=`<li class="pill">⚠️ ${msg||'Erreur de chargement'}</li>`; } }

  function bindEvents(){ $('#btnReload')?.addEventListener('click',()=>boot(true)); $('#btnExport')?.addEventListener('click',()=>exportCSV(applyFilters(RAW_ROWS)));
    $('#fPeriod')?.addEventListener('change',e=>{ FILTERS.period=e.target.value; const custom=FILTERS.period==='custom'; $('#fFrom').disabled=!custom; $('#fTo').disabled=!custom; refresh(); });
    $('#fFrom')?.addEventListener('change',e=>{ FILTERS.from=e.target.value||null; refresh(); });
    $('#fTo')?.addEventListener('change',e=>{ FILTERS.to=e.target.value||null; refresh(); });
    $('#fUTMsource')?.addEventListener('change',e=>{ FILTERS.utm_source=e.target.value; refresh(); });
    $('#fUTMmedium')?.addEventListener('change',e=>{ FILTERS.utm_medium=e.target.value; refresh(); });
    $('#fUTMcampaign')?.addEventListener('change',e=>{ FILTERS.utm_campaign=e.target.value; refresh(); });
    $('#fCountry')?.addEventListener('change',e=>{ FILTERS.country=e.target.value; refresh(); });
    $('#fDevice')?.addEventListener('change',e=>{ FILTERS.device=e.target.value; refresh(); });
    $('#fCTA')?.addEventListener('change',e=>{ FILTERS.cta=e.target.value; refresh(); });
    $('#fSearch')?.addEventListener('input',e=>{ FILTERS.search=e.target.value.trim(); refresh(); });
    $('#btnClearFilters')?.addEventListener('click',()=>{ FILTERS={ period:'30d', from:null, to:null, utm_source:'', utm_medium:'', utm_campaign:'', country:'', device:'', cta:'', search:'' }; $('#fPeriod').value='30d'; $('#fFrom').value=''; $('#fTo').value=''; $('#fFrom').disabled=true; $('#fTo').disabled=true; ['#fUTMsource','#fUTMmedium','#fUTMcampaign','#fCountry','#fDevice','#fCTA'].forEach(s=>$(s).value=''); $('#fSearch').value=''; refresh(); });
  }

  function refresh(){ const filtered=applyFilters(RAW_ROWS); renderKPIs(computeKPIs(filtered)); renderFiltersOptions(RAW_ROWS); renderSessionsTable(filtered); drawCharts(filtered); renderAcquisition(filtered); renderMiniTable(filtered); renderAlerts(true); }

  async function boot(force=false){ try{ if(force || !RAW_ROWS.length){ const csv=await fetchCsvText(); const rows2d=parseCSV(csv); const objs=mapCsvToObjects(rows2d); if(!objs.length) throw new Error('CSV vide ou entêtes non reconnues.'); RAW_ROWS=objs.map(r=>{ const o={}; COLS.forEach(k=>o[k]=(k in r)?r[k]:'' ); o._dev_group=deriveDeviceGroup(o); return o; }); } refresh(); } catch(e){ console.error(e); renderAlerts(false, e.message||'Erreur de chargement'); } }

  document.addEventListener('DOMContentLoaded',()=>{ bindEvents(); boot(); });
})();
</script>
</body>
</html>
